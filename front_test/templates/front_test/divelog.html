<!doctype html>
<html>
<head>
    <title>다이빙로그</title>
</head>
<body>
    {% load static %}
    <script src="{% static 'front_test/js/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'front_test/js/utils.js' %}" type="text/javascript"></script>
    <script>
    $(document).ready(function() {
            document.getElementById("submit").onclick = function() {
                var url = "http://127.0.0.1:8000/dive/divelogs/";
                var data = $("#frm_divelog").serialize();
                requestAjax("POST", url, data, function(){
                    alert("등록완료");
                    //location.reload(true);
                });
            }


        init();
    });

    const userId = sessionStorage.getItem("user_id");
    const pointId = window.location.search.split("=")[1];
    var diveLogs = [];

    function init(){
        getLogList();
        setForm(null);
        return;
    }

    function getLogList(){
        var url = "http://127.0.0.1:8000/dive/divelogs/";
        var data = {"point_id":pointId};
        requestAjax("GET", url, data, function(response){
            response.forEach(function(log){
                diveLogs.push(log);
            });
            initTable();
            console.log(diveLogs);
        });
        return;
    }

    function initTable(){
        for(var i=0; i<diveLogs.length; i++){
            var table = document.getElementById("table_log");
            var newRow = table.insertRow(-1);
            let cell1 = newRow.insertCell(0);
            let cell2 = newRow.insertCell(1);
            let text1 = document.createTextNode(diveLogs[i]["log_nm"]);
            let text2 = document.createTextNode(diveLogs[i]["dive_date"]);
            cell1.appendChild(text1);
            cell2.appendChild(text2);
        }
        $("#table_log tr").click(function(){
            var tr = $(this);
            for(var i=0; i<diveLogs.length; i++){
                if(tr.children()[0].textContent == diveLogs[i]["log_nm"]){
                    setForm(diveLogs[i]);
                    break;
                }
            }
        });
    }

    function setForm(log){
        if(log != null){
            $('#log_nm').val(log["log_nm"]);
            $('#dive_date').val(log["dive_date"]);
            $('#dive_time').val(log["dive_time"]);
            $('#temperature').val(log["temperature"]);
            $('#max_depth').val(log["max_depth"]);
            $('#buddy').val(log["buddy"]);
            $('#comment').val(log["comment"]);
        }
        $('#point_id').val(pointId);
        $('#diver').val(userId);
        return;
    }
    </script>
    <div style="width:50%;float:left;">
        <table id="table_log" border="1">
        </table>
    </div>
    <div style="width:50%;float:right;">
        <br><br>
        <form id="frm_divelog" name="frm_divelog">
            log_nm <input id="log_nm" type="text" name="log_nm"/><br><br>
            dive_date <input id="dive_date" type="text" name="dive_date"/><br><br>
            dive_time <input id="dive_time" name="dive_time"></textarea><br><br>
            temperature <input id="temperature" name="temperature"></textarea><br><br>
            max_depth <input id="max_depth" name="max_depth"></textarea><br><br>
            buddy <input id="buddy" type="text" name="buddy"/><br><br>
            comment <textarea id="comment" name="comment"></textarea><br><br>
            <input id="id" type="hidden" name="id"/>
            <input id="point_id" type="hidden" name="point_id"/>
            <input id="diver" type="hidden" name="diver"/>
            <input type="button" value="submit" id="submit"/>
            <input type="button" value="delete" id="delete"/>
        </form>
    </div>
</body>
</html>
