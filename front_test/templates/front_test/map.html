<html>
<head>
</head>
<body>
    {% load static %}
    <script src="{% static 'js/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{app_key}}"></script>
    <div style="width:50%;float:left;">
        <br><br>
        <div id="map" style="width:80%;height:80%;"></div>
    </div>
    <div style="width:50%;float:right;">
        <br><br>
        <form name="divepoint" action="http://127.0.0.1:8000/dive/divepoints/" method="POST">
            {% csrf_token %}
            Point id <input type="text" name="point_id" readonly/><br><br>
            Point nm <input type="text" name="point_nm"/><br><br>
            Latitude <input type="text" name="latitude" readonly/><br><br>
            Longitude <input type="text" name="longitude" readonly/><br><br>
            Diver <input type="text" name="diver" readonly/><br><br>
            Comment <textarea name="comment"></textarea><br><br>
            <input type="submit" value="submit"/>
        </form>
    </div>
    <script>
    var map;
    var markers = [];

    function getLocation() {
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          latitude = pos.coords.latitude;
          longitude = pos.coords.longitude;
        console.log("현재위치 - " + latitude + ' ' + longitude);
        }, function(error) {
          console.error(error);
          }, {
            enableHighAccuracy: false,
            maximumAge: 0,
            timeout: Infinity
          });
      }else {
        alert('GPS를 지원하지 않습니다');
      }
    }

    function initMap() {
      var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
      var options = { //지도를 생성할 때 필요한 기본 옵션
        center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
        level: 20 //지도의 레벨(확대, 축소 정도)
      };
      map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        addMarker(mouseEvent.latLng);
      });
    }

    function initMarkers() {
        $.ajax({
            type: "GET",
            url: "http://127.0.0.1:8000/dive/divepoints/",
            //data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
            dataType: "json",
            async: false,
            success: function(response){
                console.log(response);
                response.forEach(function(marker){
                    var latlng = new kakao.maps.LatLng(marker.latitude, marker.longitude);
                    addMarker(latlng)
                });
            },
            error: function(request, status, error){
                alert("error");
            }
        });
    }

    function addMarker(latlng) {
      var marker = new kakao.maps.Marker({
          position: latlng,
          clickable: true
      });
      marker.setMap(map);
      kakao.maps.event.addListener(marker, 'click', function() {
         deleteMarker(marker);
      });
      kakao.maps.event.addListener(marker, 'rightclick', function() {
          alert("rightclick!");
      });

      markers.push(marker);
      console.log("addMarker - " + latlng);
      console.log(markers);

      map.setCenter(latlng);
    }

    function deleteMarker(marker) {
        markers.forEach(function(m){
            if(m == marker) {
                console.log(m.getPosition());
                markers.splice(markers.indexOf(m), 1);
                marker.setMap(null);
                console.log(markers);
            }
        });
    }

    initMap();
    initMarkers();
    getLocation();
    </script>
    <style type="text/css">
    input:read-only{
        background-color: #ccc;
    }
    </style>
</body>
</html>
