<html>
<head>
</head>
<body>
    {% load static %}
    <script src="{% static 'front_test/js/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'front_test/js/utils.js' %}" type="text/javascript"></script>
    <link rel="stylesheet" href="{% static 'front_test/css/style.css' %}">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{app_key}}" type="text/javascript" ></script>
    <script>
    $(document).ready(function() {
        document.getElementById("submit").onclick = function() {
            url = "http://127.0.0.1:8000/dive/divepoints/";
            data = $("#frm_divepoint").serialize();
            requestAjax("POST", url, data, function(){
                alert("등록완료");
                location.reload(true);
            });
        }
        initMap();
    });

    var map;
    var markers = [];
    var points = [];

    function getCurrentLocation() {
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var lat = pos.coords.latitude;
          var lng = pos.coords.longitude;
          console.log("현재위치 - " + lat + ' ' + lng);
          moveMap(new kakao.maps.LatLng(lat, lng), 5)
        }, function(error) {
          console.error(error);
          }, {
            enableHighAccuracy: false,
            maximumAge: 0,
            timeout: Infinity
          });
      }else {
        console.log('GPS를 지원하지 않습니다');
      }
    }

    function initMap() {
      var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
      var options = { //지도를 생성할 때 필요한 기본 옵션
        center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
        level: 20 //지도의 레벨(확대, 축소 정도)
      };
      map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        addMarker('', mouseEvent.latLng);
      });

      initMarkers()
    }

    function initMarkers() {
        var url = "http://127.0.0.1:8000/dive/divepoints/";
        var data = {"diver":{{session_id}}};
        requestAjax("GET", url, data, function (response){
            response.forEach(function(point){
                points.push(point)
                addMarker(point.point_nm, new kakao.maps.LatLng(point.latitude, point.longitude));
            });
            $('#frm_divepoint')[0].reset();
        });
        $('#diver').val({{session_id}});
    }

    function addMarker(title, latlng) {
      var fixedLatLng = getFixedLatLng(latlng);
      var marker = new kakao.maps.Marker({
          title: title,
          position: fixedLatLng,
          clickable: true
      });
      kakao.maps.event.addListener(marker, 'click', function() {
          moveMap(marker.getPosition());
          $('#frm_divepoint')[0].reset();
          getPointInfo(marker);
      });
      kakao.maps.event.addListener(marker, 'rightclick', function() {
          deleteMarker(marker);
      });
      marker.setMap(map);
      markers.push(marker);
      moveMap(fixedLatLng);
      $('#frm_divepoint')[0].reset();
      $('#latitude').val(fixedLatLng.getLat());
      $('#longitude').val(fixedLatLng.getLng());
    }

    function deleteMarker(marker) {
        markers.forEach(function(m){
            if(m == marker) {
                markers.splice(markers.indexOf(m), 1);
                marker.setMap(null);
            }
        });
    }

    function getPointInfo(marker) {
        var fixedLatLng = getFixedLatLng(marker.getPosition());
        if(pointExists(fixedLatLng)){
            $('#point_nm').val(p.point_nm);
            $('#latitude').val(p.latitude);
            $('#longitude').val(p.longitude);
            $('#comment').val(p.comment);
        } else{
            $('#latitude').val(fixedLatLng.getLat());
            $('#longitude').val(fixedLatLng.getLng());
        }
    }

    function moveMap(latlng, level=10){
        map.setCenter(latlng);
        map.setLevel(level);
    }

    function getFixedLatLng(latLng){
        var fixedLat = Number(latLng.getLat()).toFixed(10);
        var fixedLng = Number(latLng.getLng()).toFixed(10);
        return new kakao.maps.LatLng(fixedLat, fixedLng);
    }

    function pointExists(latlng){
        points.forEach(function(p){
            if(latlng.toString() === new kakao.maps.LatLng(p.latitude, p.longitude).toString()){
                console.log(p.point_nm);
                return p;
            } else{
                return false;
            }
        });
    }

    </script>
    <div style="width:50%;float:left;">
        <br><br>
        <div id="map" style="width:80%;height:80%;"></div>
    </div>
    <div style="width:50%;float:right;">
        <br><br>
        로그인 유저 : {{session_email}}
        <button type="button" name="logout" style="width:60px;height:30px;"
        onclick="location.href='http://127.0.0.1:8000/accounts/logout/'">logout</button>
        <br><br>
        <form id="frm_divepoint" name="frm_divepoint">
            {% csrf_token %}
            Point nm <input id="point_nm" type="text" name="point_nm"/><br><br>
            Latitude <input id="latitude" type="text" name="latitude"/><br><br>
            Longitude <input id="longitude" type="text" name="longitude"/><br><br>
            Comment <textarea id="comment" name="comment"></textarea><br><br>
            <input id="diver" type="hidden" name="diver"/>
            <input id="id" type="hidden"/>
            <input type="button" value="submit" id="submit"/>
        </form>
    </div>
</body>
</html>
