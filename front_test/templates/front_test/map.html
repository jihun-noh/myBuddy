<html>
<head>
</head>
<body>
    {% load static %}
    <script src="{% static 'front_test/js/jquery-3.5.1.min.js' %}" type="text/javascript"></script>
    <link rel="stylesheet" href="{% static 'front_test/css/style.css' %}">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{app_key}}"></script>
    <script>
    $(document).ready(function() {
        initMap();
        initMarkers();
        getLocation();
    });

    var map;
    var markers = [];

    function getLocation() {
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          latitude = pos.coords.latitude;
          longitude = pos.coords.longitude;
        console.log("현재위치 - " + latitude + ' ' + longitude);
        }, function(error) {
          console.error(error);
          }, {
            enableHighAccuracy: false,
            maximumAge: 0,
            timeout: Infinity
          });
      }else {
        alert('GPS를 지원하지 않습니다');
      }
    }

    function initMap() {
      var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
      var options = { //지도를 생성할 때 필요한 기본 옵션
        center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
        level: 20 //지도의 레벨(확대, 축소 정도)
      };
      map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        addMarker(mouseEvent.latLng);
      });
    }

    function initMarkers() {
        $.ajax({
            type: "GET",
            url: "http://127.0.0.1:8000/dive/divepoints/",
            //data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
            dataType: "json",
            async: false,
            success: function(response){
                console.log(response);
                response.forEach(function(marker){
                    var latlng = new kakao.maps.LatLng(marker.latitude, marker.longitude);
                    addMarker(latlng)
                });
                $('#diver').val({{session_id}});
            },
            error: function(request, status, error){
                alert("error");
            }
        });
    }

    function addMarker(latlng) {
      var marker = new kakao.maps.Marker({
          position: latlng,
          clickable: true
      });
      marker.setMap(map);
      kakao.maps.event.addListener(marker, 'click', function() {
         deleteMarker(marker);
      });
      kakao.maps.event.addListener(marker, 'rightclick', function() {
          alert("rightclick!");
      });

      markers.push(marker);
      $('#latitude').val(latlng.getLat());
      $('#longitude').val(latlng.getLng());
      console.log("addMarker - " + latlng);
      console.log(markers);

      map.setCenter(latlng);
    }

    function deleteMarker(marker) {
        markers.forEach(function(m){
            if(m == marker) {
                console.log(m.getPosition());
                markers.splice(markers.indexOf(m), 1);
                marker.setMap(null);
                console.log(markers);
            }
        });
    }

    function submitAjax() {
        var formData = $("#divepoint").serialize();
        $.ajax({
            type: "POST",
            url: "http://127.0.0.1:8000/dive/divepoints/",
            data: formData,
            dataType: "json",
            success: function(response){
                console.log(response);
                alert("저장 성공")
            },
            error: function(request, status, error){
                console.log(request.responseText);
                alert(request.responseText);
            }
        });
    }

    </script>
    <div style="width:50%;float:left;">
        <br><br>
        <div id="map" style="width:80%;height:80%;"></div>
    </div>
    <div style="width:50%;float:right;">
        <br><br>
        로그인 유저 : {{session_email}}
        <button type="button" name="logout" style="width:60px;height:30px;"
        onclick="location.href='http://127.0.0.1:8000/accounts/logout/'">logout</button>
        <br><br>
        <form id="divepoint" name="divepoint">
            {% csrf_token %}
            Point nm <input id="point_nm" type="text" name="point_nm"/><br><br>
            Latitude <input id="latitude" type="text" name="latitude"/><br><br>
            Longitude <input id="longitude" type="text" name="longitude"/><br><br>
            Diver <input id="diver" type="text" name="diver" readonly/><br><br>
            Comment <textarea id="comment" name="comment"></textarea><br><br>
            <input type="button" value="submit" onclick="submitAjax()"/>
        </form>
    </div>
</body>
</html>
